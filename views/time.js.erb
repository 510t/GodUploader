var startFlag = false;
var endFlag = false;

$(function() {

  checkSession();

  $( '#selectOdai' ).on('click', function() {

    $('input[name=odaiFile]').trigger('click');

  });

  $( 'input[name=odaiFile]' ).change(function() {

    var path = $(this).val().split('\\');

    $('#odaicover').val(path.pop());

  });

  $( '#selectImage' ).on('click', function() {

    $('input[name=image]').trigger('click');

  });

  $( 'input[name=image]' ).change(function() {

    var path = $(this).val().split('\\');

    $('#imagecover').val(path.pop());

  });

  $( '#passwordinput' ).change( function(){
    $( 'input[name=password]' ).val( $(this).val() )
  });

  

});

function upload( form,id ){
  form.action = "<%= uri( "/uploadImage/",false ) %>" + id;
  form.submit();
}

function tweet( form,id ){
  form.action = "<%= uri( "/tweetwithimage/",false ) %>" + id;
  form.submit();
}

function checkSession(){

  var isstart = $("#isstart").val();
  var isfinished = $( "#isfinished" ).val();

  if( isstart == "true" ){
    if ( isfinished == "true" ){
    
    }else {
      if( !endFlag )countDown();
    }
  }else {
    
  }

    $.ajax({
      type: "GET",
      url: "<%= uri( '/autoreload',false) %>",
      dataType: 'json',
      data: {
        id: $( "#sessionid" ).val()
      }      
    }).done(function(result){
      if( result.autoreload ){
        location.reload(true);
      }
    });

   setTimeout('checkSession()', 1000);

}

function countDown() {

  var startDateTime = new Date();
  var d = new moment($("#endTime").val(), "YYYY-MM-DD HH:mm:ss");
  var endDateTime = new Date( d );

  var left = endDateTime - startDateTime;
  var a_hour =  60 * 60 * 1000;

  // 期限から現在までの『残時間の時間の部分』
  var h = Math.floor(left /  a_hour)

  // 残時間を秒で割って残分数を出す。
  // 残分数を60で割ることで、残時間の「時」の余りとして、『残時間の分の部分』を出す
  var m = Math.floor((left % a_hour) / (60 * 1000)) % 60 

  // 残時間をミリ秒で割って、残秒数を出す。
  // 残秒数を60で割った余りとして、「秒」の余りとしての残「ミリ秒」を出す。
  // 更にそれを60で割った余りとして、「分」で割った余りとしての『残時間の秒の部分』を出す
  var s = Math.floor((left % a_hour) / 1000) % 60 % 60 
    
    
  if( !startFlag ){ 
    startFlag = true
    //後で直す
    document.getElementById('startsound').play();
//    var se = $('#startsound');
//    se[0].currentTime = 0;
//    se[0].play();
  }else if ( left <= 0 ){
    
    endFlag = true;
    h = m = s = 0;

    $.ajax({
      type: "POST",
      url: "<%= uri( '/endsession',false) %>" ,
      dataType: 'json',
      data: {
        id: $( "#sessionid" ).val()
      }            
    });

    document.getElementById('endsound').play();
//    var se = $('#endsound');
//    se[0].currentTime = 0;
//    se[0].play();
    $( '#forceend' ).hide();
    $( '#update' ).show();
 

  }
  

  $("#TimeLeft").text(h + '時間' + m + '分' + s + '秒');

}


